<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>苗栗社福促進協會物資管理平台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'chinese': ['Microsoft JhengHei', 'PingFang TC', 'Noto Sans TC', 'sans-serif']
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-100 min-h-screen font-chinese">


    <div class="container mx-auto px-4 py-8">
        <div class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-2">苗栗社福促進協會物資管理平台</h1> <p class="text-gray-600 text-sm sm:text-base">T-Cross x苗栗物資共享站 合作開發</p> </div>

        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex flex-col md:flex-row gap-4 justify-between items-center">
                <div class="flex flex-wrap gap-3 w-full md:w-auto mb-4 md:mb-0 justify-center md:justify-start">
                    <button onclick="openModal('add')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center gap-2 text-sm sm:text-base w-full sm:w-auto">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        新增物資
                    </button>
                    <button onclick="openBarcodeScanner()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center gap-2 text-sm sm:text-base w-full sm:w-auto">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path>
                        </svg>
                        掃描條碼
                    </button>
                    <button onclick="exportData()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center gap-2 text-sm sm:text-base w-full sm:w-auto">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        匯出報表
                    </button>
                    <button onclick="printReceipt()" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center gap-2 text-sm sm:text-base w-full sm:w-auto">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
                        </svg>
                        捐贈物品收據列印
                    </button>
                </div>
                <div class="flex gap-3 w-full md:w-auto"> <input type="text" id="searchInput" placeholder="搜尋物資名稱或條碼..." class="border border-gray-300 rounded-lg px-4 py-2 w-full focus:outline-none focus:ring-2 focus:ring-green-500">
                    <button onclick="searchItems()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors duration-200">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 text-green-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">總物資種類</p>
                        <p class="text-2xl font-bold text-gray-900" id="totalItems">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">本月捐贈</p>
                        <p class="text-2xl font-bold text-gray-900" id="monthlyDonation">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-orange-100 text-orange-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">本月發放</p>
                        <p class="text-2xl font-bold text-gray-900" id="monthlyDistribution">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-red-100 text-red-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">庫存不足</p>
                        <p class="text-2xl font-bold text-gray-900" id="lowStock">0</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 flex flex-col sm:flex-row justify-between items-center"> <h2 class="text-xl font-semibold text-gray-800 mb-2 sm:mb-0">物資庫存清單</h2>
                <button id="expandBtn" onclick="toggleDetailView()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center gap-2 w-full sm:w-auto justify-center">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                    展開詳細檢視
                </button>
            </div>
            <div id="normalView" class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">物資圖片</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">物資名稱</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">國際條碼</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">單位</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">庫存數量</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">建單日期</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">最後更新</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody id="itemsTable" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
            
            <div id="detailView" class="hidden">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800">詳細物資資訊</h3>
                </div>
                <div id="detailContent" class="p-6">
                    </div>
            </div>
        </div>
    </div>

    <div id="itemModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 max-h-screen overflow-y-auto">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 id="modalTitle" class="text-lg font-semibold text-gray-900">新增物資</h3>
            </div>
            <form id="itemForm" class="px-6 py-4">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">操作類型</label>
                        <select id="operationType" onchange="toggleReceiptFields()" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                            <option value="corporate">企業捐贈</option>
                            <option value="designated">指定捐贈</option>
                            <option value="donation">個人捐贈</option>
                        </select>
                    </div>
                    <div>
                        <button type="button" id="receiptBtn" onclick="toggleReceiptMode()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            開立收據
                        </button>
                    </div>
                    
                    <div id="personalReceiptFields" class="hidden space-y-4 bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <h4 class="text-sm font-medium text-blue-800 mb-2">個人捐贈者資訊</h4>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">姓名</label>
                            <input type="text" id="donorName" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="請輸入捐贈者姓名">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">電話</label>
                            <input type="tel" id="donorPhone" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="請輸入聯絡電話">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">地址</label>
                            <input type="text" id="donorAddress" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="請輸入地址">
                        </div>
                    </div>
                    
                    <div id="corporateReceiptFields" class="hidden space-y-4 bg-green-50 p-4 rounded-lg border border-green-200">
                        <h4 class="text-sm font-medium text-green-800 mb-2">企業捐贈者資訊</h4>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">公司抬頭</label>
                            <input type="text" id="companyName" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="請輸入公司名稱">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">統一編號</label>
                            <input type="text" id="companyTaxId" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="請輸入統一編號">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">公司地址</label>
                            <input type="text" id="companyAddress" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="請輸入公司地址">
                        </div>
                    </div>
                    
                    <div id="designatedReceiptFields" class="hidden space-y-4 bg-purple-50 p-4 rounded-lg border border-purple-200">
                        <h4 class="text-sm font-medium text-purple-800 mb-2">指定捐贈者資訊</h4>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">抬頭</label>
                            <input type="text" id="designatedName" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="請輸入捐贈者抬頭">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">統編/電話</label>
                            <input type="text" id="designatedIdOrPhone" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="請輸入統一編號或電話">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">地址</label>
                            <input type="text" id="designatedAddress" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="請輸入地址">
                        </div>
                    </div>
                    
                    <div id="designatedDonationFields" class="space-y-4 bg-indigo-50 p-4 rounded-lg border border-indigo-200" style="display: none;">
                        <h4 class="text-sm font-medium text-indigo-800 mb-2">指定捐贈資訊</h4>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">指定對象</label>
                            <input type="text" id="designatedTarget" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="例：苗栗縣XX協會">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">物資名稱</label>
                        <input type="text" id="itemName" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="例：白米、罐頭、衣物">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">國際條碼</label>
                        <div class="flex gap-2">
                            <input type="text" id="itemBarcode" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="掃描或手動輸入條碼">
                            <button type="button" onclick="openBarcodeScanner()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors duration-200 flex-shrink-0"> <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path>
                                </svg>
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">可選填，有助於快速識別物資</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">單位</label>
                        <select id="itemUnit" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                            <option value="包">包</option>
                            <option value="箱">箱</option>
                            <option value="個">個</option>
                            <option value="件">件</option>
                            <option value="公斤">公斤</option>
                            <option value="公升">公升</option>
                            <option value="組">組</option>
                            <option value="份">份</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">數量</label>
                        <input type="number" id="itemQuantity" required min="0" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">物資圖片</label>
                        <input type="file" id="itemImage" accept="image/*" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                        <p class="text-xs text-gray-500 mt-1">支援 JPG, PNG, GIF 格式</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">備註</label>
                        <textarea id="itemNotes" rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="捐贈者資訊、受助者資訊或其他備註"></textarea>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="lineNotify" class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded">
                        <label for="lineNotify" class="ml-2 block text-sm text-gray-700">用LINE通知</label>
                    </div>
                </div>
            </form>
            <div class="px-6 py-4 border-t border-gray-200 flex justify-end gap-3">
                <button onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors duration-200">取消</button>
                <button onclick="saveItem()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium transition-colors duration-200">儲存</button>
            </div>
        </div>
    </div>

    <div id="barcodeModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">條碼掃描</h3>
            </div>
            <div class="px-6 py-4">
                <div id="barcodeReader" class="w-full h-64 bg-gray-100 rounded-lg flex items-center justify-center mb-4">
                    <div class="text-center">
                        <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <p class="text-gray-600">準備開啟相機掃描條碼</p>
                        <p class="text-xs text-gray-500 mt-2">需要 HTTPS 環境才能使用相機功能</p>
                    </div>
                </div>
                <div id="barcodeResult" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">掃描結果</label>
                    <input type="text" id="scannedBarcode" readonly class="w-full border border-gray-300 rounded-lg px-3 py-2 bg-gray-50">
                </div>
            </div>
            <div class="px-6 py-4 border-t border-gray-200 flex justify-end gap-3">
                <button onclick="closeBarcodeScanner()" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors duration-200">取消</button>
                <button id="useBarcodeBtn" onclick="useScannedBarcode()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg font-medium transition-colors duration-200 hidden">使用此條碼</button>
            </div>
        </div>
    </div>

    <script>
        // 物資資料存儲
        let items = JSON.parse(localStorage.getItem('charityItems')) || [
            {
                name: '白米',
                barcode: '4710123456789',
                unit: '包',
                quantity: 25,
                notes: '企業捐贈 - 統一企業',
                createdDate: '07/01',
                lastUpdated: '2025/07/01',
                image: null,
                operations: [{
                    type: 'corporate',
                    quantity: 25,
                    date: '2025/07/01',
                    notes: '企業捐贈 - 統一企業'
                }]
            },
            {
                name: '罐頭食品',
                barcode: '4710987654321',
                unit: '個',
                quantity: 0,
                notes: '個人捐贈 - 王小明',
                createdDate: '07/02',
                lastUpdated: '2025/07/02',
                image: null,
                operations: [{
                    type: 'donation',
                    quantity: 0,
                    date: '2025/07/02',
                    notes: '個人捐贈 - 王小明'
                }]
            },
            {
                name: '冬季外套',
                barcode: '',
                unit: '件',
                quantity: 15,
                notes: '指定捐贈 - 苗栗縣愛心協會',
                createdDate: '07/03',
                lastUpdated: '2025/07/03',
                image: null,
                operations: [{
                    type: 'designated',
                    quantity: 15,
                    date: '2025/07/03',
                    notes: '指定捐贈 - 苗栗縣愛心協會'
                }]
            },
            {
                name: '奶粉',
                barcode: '4710555666777',
                unit: '罐',
                quantity: 8,
                notes: '企業捐贈 - 雀巢公司',
                createdDate: '07/04',
                lastUpdated: '2025/07/04',
                image: null,
                operations: [{
                    type: 'corporate',
                    quantity: 8,
                    date: '2025/07/04',
                    notes: '企業捐贈 - 雀巢公司'
                }]
            },
            {
                name: '毛毯',
                barcode: '',
                unit: '條',
                quantity: 2,
                notes: '個人捐贈 - 李太太',
                createdDate: '07/05',
                lastUpdated: '2025/07/05',
                image: null,
                operations: [{
                    type: 'donation',
                    quantity: 2,
                    date: '2025/07/05',
                    notes: '個人捐贈 - 李太太'
                }]
            }
        ];
        let editingIndex = -1;
        let codeReader = null;

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            renderItems();
            updateStats();
            
            // 搜尋功能
            document.getElementById('searchInput').addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    searchItems();
                }
            });

            // 初始化條碼掃描器
            try {
                codeReader = new ZXing.BrowserBarcodeReader();
            } catch (error) {
                console.log('條碼掃描器初始化失敗:', error);
            }
        });

        // 開啟 Modal
        function openModal(mode, index = -1) {
            const modal = document.getElementById('itemModal');
            const title = document.getElementById('modalTitle');
            
            if (mode === 'add') {
                title.textContent = '新增物資';
                document.getElementById('itemForm').reset();
                editingIndex = -1;
                // 重置收據模式
                receiptMode = false;
                const btn = document.getElementById('receiptBtn');
                btn.innerHTML = `
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    開立收據
                `;
                btn.classList.remove('bg-red-600', 'hover:bg-red-700');
                btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                hideAllReceiptFields();
                // 初始化時檢查操作類型
                toggleReceiptFields();
            } else if (mode === 'edit') {
                title.textContent = '編輯物資';
                const item = items[index];
                document.getElementById('itemName').value = item.name;
                document.getElementById('itemBarcode').value = item.barcode || '';
                document.getElementById('itemUnit').value = item.unit;
                document.getElementById('itemQuantity').value = item.quantity;
                document.getElementById('operationType').value = 'corporate';
                document.getElementById('itemNotes').value = item.notes || '';
                editingIndex = index;
                // 編輯模式不顯示收據功能
                receiptMode = false;
                hideAllReceiptFields();
            }
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // 關閉 Modal
        function closeModal() {
            const modal = document.getElementById('itemModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // 開啟條碼掃描器
        function openBarcodeScanner() {
            const modal = document.getElementById('barcodeModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            if (!codeReader) {
                alert('條碼掃描功能不可用，請手動輸入條碼');
                return;
            }

            // 檢查是否為 HTTPS
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                document.getElementById('barcodeReader').innerHTML = `
                    <div class="text-center text-red-600">
                        <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                        <p class="font-medium">需要 HTTPS 環境</p>
                        <p class="text-sm mt-2">相機功能需要安全連線才能使用</p>
                    </div>
                `;
                return;
            }

            // 開始掃描
            startBarcodeScanning();
        }

        // 開始條碼掃描
        function startBarcodeScanning() {
            const videoElement = document.createElement('video');
            videoElement.style.width = '100%';
            videoElement.style.height = '100%';
            videoElement.style.objectFit = 'cover';
            
            document.getElementById('barcodeReader').innerHTML = '';
            document.getElementById('barcodeReader').appendChild(videoElement);

            codeReader.decodeFromVideoDevice(null, videoElement, (result, err) => {
                if (result) {
                    document.getElementById('scannedBarcode').value = result.text;
                    document.getElementById('barcodeResult').classList.remove('hidden');
                    document.getElementById('useBarcodeBtn').classList.remove('hidden');
                    
                    // 停止掃描
                    codeReader.reset();
                    document.getElementById('barcodeReader').innerHTML = `
                        <div class="text-center text-green-600">
                            <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <p class="font-medium">掃描成功！</p>
                            <p class="text-sm mt-2">條碼：${result.text}</p>
                        </div>
                    `;
                }
            }).catch(err => {
                console.error('掃描錯誤:', err);
                document.getElementById('barcodeReader').innerHTML = `
                    <div class="text-center text-red-600">
                        <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                        <p class="font-medium">無法開啟相機</p>
                        <p class="text-sm mt-2">請檢查相機權限或手動輸入條碼</p>
                    </div>
                `;
            });
        }

        // 關閉條碼掃描器
        function closeBarcodeScanner() {
            if (codeReader) {
                codeReader.reset();
            }
            const modal = document.getElementById('barcodeModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            
            // 重置掃描結果
            document.getElementById('barcodeResult').classList.add('hidden');
            document.getElementById('useBarcodeBtn').classList.add('hidden');
        }

        // 使用掃描的條碼
        function useScannedBarcode() {
            const barcode = document.getElementById('scannedBarcode').value;
            document.getElementById('itemBarcode').value = barcode;
            closeBarcodeScanner();
            
            // 如果物資 Modal 沒有開啟，則開啟它
            const itemModal = document.getElementById('itemModal');
            if (itemModal.classList.contains('hidden')) {
                openModal('add');
            }
        }

        // 儲存物資
        function saveItem() {
            const name = document.getElementById('itemName').value;
            const barcode = document.getElementById('itemBarcode').value;
            const unit = document.getElementById('itemUnit').value;
            const quantity = parseInt(document.getElementById('itemQuantity').value);
            const operationType = document.getElementById('operationType').value;
            const notes = document.getElementById('itemNotes').value;
            const imageFile = document.getElementById('itemImage').files[0];
            
            if (!name || quantity < 0) {
                alert('請填寫完整資訊');
                return;
            }

            const item = {
                name: name,
                barcode: barcode,
                unit: unit,
                quantity: quantity,
                notes: notes,
                createdDate: new Date().toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit' }),
                lastUpdated: new Date().toLocaleDateString('zh-TW'),
                image: null,
                operations: []
            };

            // 處理圖片
            if (imageFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    item.image = e.target.result;
                    saveItemData(item, operationType);
                };
                reader.readAsDataURL(imageFile);
            } else {
                saveItemData(item, operationType);
            }
        }

        function saveItemData(item, operationType) {
            if (editingIndex === -1) {
                // 新增物資
                item.operations.push({
                    type: operationType,
                    quantity: item.quantity,
                    date: new Date().toLocaleDateString('zh-TW'),
                    notes: item.notes
                });
                items.push(item);
            } else {
                // 編輯物資
                const existingItem = items[editingIndex];
                const quantityDiff = item.quantity - existingItem.quantity;
                
                existingItem.name = item.name;
                existingItem.barcode = item.barcode;
                existingItem.unit = item.unit;
                existingItem.quantity = item.quantity;
                existingItem.notes = item.notes;
                existingItem.lastUpdated = item.lastUpdated;
                
                if (item.image) {
                    existingItem.image = item.image;
                }
                
                existingItem.operations.push({
                    type: operationType,
                    quantity: quantityDiff,
                    date: new Date().toLocaleDateString('zh-TW'),
                    notes: item.notes
                });
            }

            localStorage.setItem('charityItems', JSON.stringify(items));
            renderItems();
            updateStats();
            closeModal();
        }

        // 渲染物資列表
        function renderItems(filteredItems = null) {
            const tbody = document.getElementById('itemsTable');
            const itemsToRender = filteredItems || items;
            
            if (itemsToRender.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center">
                                <svg class="w-12 h-12 text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-2.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 009.586 13H7"></path>
                                </svg>
                                <p class="text-lg font-medium">尚無物資資料</p>
                                <p class="text-sm">點擊「新增物資」開始建立愛心物資庫存</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = itemsToRender.map((item, index) => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="w-16 h-16 bg-gray-200 rounded-lg flex items-center justify-center overflow-hidden">
                            ${item.image ? 
                                `<img src="${item.image}" alt="${item.name}" class="w-full h-full object-cover">` :
                                `<svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>`
                            }
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${item.name}</div>
                        ${item.notes ? `<div class="text-xs text-gray-500">${item.notes}</div>` : ''}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900 font-mono">${item.barcode || '-'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${item.unit}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium ${item.quantity === 0 ? 'text-red-600' : item.quantity < 5 ? 'text-orange-600' : 'text-gray-900'}">${item.quantity}</div>
                        ${item.quantity === 0 ? '<div class="text-xs text-red-500">發送完畢</div>' : item.quantity < 5 ? '<div class="text-xs text-orange-500">庫存不足</div>' : ''}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${item.createdDate || '-'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${item.lastUpdated}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="openModal('edit', ${index})" class="text-green-600 hover:text-green-900 mr-3">編輯</button>
                        <button onclick="deleteItem(${index})" class="text-red-600 hover:text-red-900">刪除</button>
                    </td>
                </tr>
            `).join('');
        }

        // 刪除物資
        function deleteItem(index) {
            if (confirm('確定要刪除此物資嗎？')) {
                items.splice(index, 1);
                localStorage.setItem('charityItems', JSON.stringify(items));
                renderItems();
                updateStats();
            }
        }

        // 搜尋物資
        function searchItems() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (searchTerm === '') {
                renderItems();
            } else {
                const filteredItems = items.filter(item => 
                    item.name.toLowerCase().includes(searchTerm) ||
                    (item.barcode && item.barcode.includes(searchTerm))
                );
                renderItems(filteredItems);
            }
        }

        // 更新統計資料
        function updateStats() {
            document.getElementById('totalItems').textContent = items.length;
            
            const currentMonth = new Date().getMonth();
            let monthlyDonation = 0;
            let monthlyDistribution = 0;
            let lowStock = 0;

            items.forEach(item => {
                // 計算低庫存
                if (item.quantity < 5) {
                    lowStock++;
                }

                // 計算本月捐贈和發放
                if (item.operations) {
                    item.operations.forEach(op => {
                        const opDate = new Date(op.date);
                        if (opDate.getMonth() === currentMonth) {
                            if (op.type === 'donation' || op.type === 'corporate' || op.type === 'designated') {
                                monthlyDonation += op.quantity;
                            } else if (op.type === 'distribution') {
                                monthlyDistribution += Math.abs(op.quantity);
                            }
                        }
                    });
                }
            });

            document.getElementById('monthlyDonation').textContent = monthlyDonation;
            document.getElementById('monthlyDistribution').textContent = monthlyDistribution;
            document.getElementById('lowStock').textContent = lowStock;
        }

        // 匯出資料
        function exportData() {
            if (items.length === 0) {
                alert('沒有資料可以匯出');
                return;
            }

            const csvContent = "data:text/csv;charset=utf-8," 
                + "物資名稱,國際條碼,單位,數量,最後更新,備註\n"
                + items.map(item => `${item.name},${item.barcode || ''},${item.unit},${item.quantity},${item.lastUpdated},"${item.notes || ''}"`).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `物資清單_${new Date().toLocaleDateString('zh-TW')}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 列印捐贈收據
        function printReceipt() {
            // 篩選出捐贈類型的物資
            const donationItems = items.filter(item => {
                return item.operations && item.operations.some(op => 
                    op.type === 'donation' || op.type === 'corporate' || op.type === 'designated'
                );
            });

            if (donationItems.length === 0) {
                alert('目前沒有捐贈物資可以列印收據');
                return;
            }

            // 建立收據內容
            const receiptWindow = window.open('', '_blank');
            const currentDate = new Date().toLocaleDateString('zh-TW');
            
            receiptWindow.document.write(`
                <!DOCTYPE html>
                <html lang="zh-TW">
                <head>
                    <meta charset="UTF-8">
                    <title>愛心物資捐贈收據</title>
                    <style>
                        body { font-family: 'Microsoft JhengHei', sans-serif; margin: 40px; line-height: 1.6; }
                        .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
                        .title { font-size: 24px; font-weight: bold; color: #2563eb; margin-bottom: 10px; }
                        .subtitle { font-size: 16px; color: #666; }
                        .info-section { margin: 20px 0; }
                        .info-row { display: flex; margin: 10px 0; }
                        .label { font-weight: bold; width: 120px; }
                        .value { flex: 1; border-bottom: 1px dotted #ccc; padding-bottom: 2px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                        th { background-color: #f8f9fa; font-weight: bold; }
                        .footer { margin-top: 40px; text-align: center; font-size: 14px; color: #666; }
                        .signature { margin-top: 50px; display: flex; justify-content: space-between; }
                        .sign-box { text-align: center; }
                        .sign-line { border-bottom: 1px solid #333; width: 150px; margin: 20px auto; }
                        @media print { body { margin: 20px; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="title">愛心物資捐贈收據</div>
                        <div class="subtitle">DONATION RECEIPT</div>
                    </div>
                    
                    <div class="info-section">
                        <div class="info-row">
                            <span class="label">收據編號：</span>
                            <span class="value">R${Date.now().toString().slice(-8)}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">開立日期：</span>
                            <span class="value">${currentDate}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">捐贈者姓名：</span>
                            <span class="value"></span>
                        </div>
                        <div class="info-row">
                            <span class="label">聯絡電話：</span>
                            <span class="value"></span>
                        </div>
                        <div class="info-row">
                            <span class="label">地址：</span>
                            <span class="value"></span>
                        </div>
                    </div>

                    <h3>捐贈物資明細</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>物資名稱</th>
                                <th>數量</th>
                                <th>單位</th>
                                <th>捐贈日期</th>
                                <th>備註</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${donationItems.map(item => {
                                const donationOp = item.operations.find(op => 
                                    op.type === 'donation' || op.type === 'corporate' || op.type === 'designated'
                                );
                                return `
                                    <tr>
                                        <td>${item.name}</td>
                                        <td>${donationOp ? donationOp.quantity : item.quantity}</td>
                                        <td>${item.unit}</td>
                                        <td>${donationOp ? donationOp.date : item.lastUpdated}</td>
                                        <td>${item.notes || ''}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>

                    <div class="info-section">
                        <p><strong>感謝您的愛心捐贈！</strong></p>
                        <p>您所捐贈的物資將用於幫助需要的弱勢族群，讓愛心傳遞到社會每個角落。</p>
                        <p>本收據僅作為捐贈證明，如需正式捐贈證明書，請洽詢相關單位。</p>
                    </div>

                    <div class="signature">
                        <div class="sign-box">
                            <div class="sign-line"></div>
                            <div>捐贈者簽名</div>
                        </div>
                        <div class="sign-box">
                            <div class="sign-line"></div>
                            <div>機構代表簽名</div>
                        </div>
                    </div>

                    <div class="footer">
                        <p>苗栗社福促進協會物資管理平台 · 列印日期：${currentDate}</p>
                        <p>此為系統自動產生的收據範本，實際使用請依各機構規定調整</p>
                    </div>
                </body>
                </html>
            `);
            
            receiptWindow.document.close();
            
            // 等待內容載入後自動列印
            setTimeout(() => {
                receiptWindow.print();
            }, 500);
        }

        // 收據模式控制
        let receiptMode = false;

        function toggleReceiptMode() {
            receiptMode = !receiptMode;
            const btn = document.getElementById('receiptBtn');
            
            if (receiptMode) {
                btn.textContent = '取消收據';
                btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                btn.classList.add('bg-red-600', 'hover:bg-red-700');
                toggleReceiptFields();
            } else {
                btn.innerHTML = `
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    開立收據
                `;
                btn.classList.remove('bg-red-600', 'hover:bg-red-700');
                btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                hideAllReceiptFields();
            }
        }

        function toggleReceiptFields() {
            const operationType = document.getElementById('operationType').value;
            
            // 先隱藏所有收據欄位
            hideAllReceiptFields();
            
            // 指定捐贈欄位獨立顯示（不受收據模式影響）
            if (operationType === 'designated') {
                document.getElementById('designatedDonationFields').style.display = 'block';
            } else {
                document.getElementById('designatedDonationFields').style.display = 'none';
            }
            
            // 收據欄位只在收據模式下顯示
            if (!receiptMode) return;
            
            if (operationType === 'donation') {
                document.getElementById('personalReceiptFields').classList.remove('hidden');
            } else if (operationType === 'corporate') {
                document.getElementById('corporateReceiptFields').classList.remove('hidden');
            } else if (operationType === 'designated') {
                document.getElementById('designatedReceiptFields').classList.remove('hidden');
            }
        }

        function hideAllReceiptFields() {
            document.getElementById('personalReceiptFields').classList.add('hidden');
            document.getElementById('corporateReceiptFields').classList.add('hidden');
            document.getElementById('designatedReceiptFields').classList.add('hidden');
            // 指定捐贈欄位不在這裡隱藏，因為它是獨立的
        }

        // 詳細檢視切換
        function toggleDetailView() {
            const normalView = document.getElementById('normalView');
            const detailView = document.getElementById('detailView');
            const expandBtn = document.getElementById('expandBtn');
            const headerSection = document.querySelector('.container > div:nth-child(2)'); // 操作按鈕區
            const statsSection = document.querySelector('.container > div:nth-child(3)'); // 統計區
            
            if (detailView.classList.contains('hidden')) {
                // 切換到詳細檢視
                normalView.classList.add('hidden');
                detailView.classList.remove('hidden');
                headerSection.classList.add('hidden');
                statsSection.classList.add('hidden');
                
                expandBtn.innerHTML = `
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                    </svg>
                    收合檢視
                `;
                
                renderDetailView();
            } else {
                // 切換回一般檢視
                normalView.classList.remove('hidden');
                detailView.classList.add('hidden');
                headerSection.classList.remove('hidden');
                statsSection.classList.remove('hidden');
                
                expandBtn.innerHTML = `
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                    展開詳細檢視
                `;
            }
        }

        // 渲染詳細檢視
        function renderDetailView() {
            const detailContent = document.getElementById('detailContent');
            
            if (items.length === 0) {
                detailContent.innerHTML = `
                    <div class="text-center py-12">
                        <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-2.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 009.586 13H7"></path>
                        </svg>
                        <p class="text-lg font-medium text-gray-500">尚無物資資料</p>
                    </div>
                `;
                return;
            }

            detailContent.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${items.map((item, index) => `
                        <div class="bg-white rounded-lg border border-gray-200 p-4 hover:shadow-md transition-shadow duration-200">
                            <div class="w-full h-32 bg-gray-100 rounded-lg flex items-center justify-center overflow-hidden mb-3">
                                ${item.image ? 
                                    `<img src="${item.image}" alt="${item.name}" class="w-full h-full object-cover">` :
                                    `<svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>`
                                }
                            </div>
                            
                            <h4 class="text-lg font-bold text-gray-900 mb-2">${item.name}</h4>
                            
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-2xl font-bold ${item.quantity === 0 ? 'text-red-600' : item.quantity < 5 ? 'text-orange-600' : 'text-green-600'}">${item.quantity}</span>
                                <span class="text-sm text-gray-600">${item.unit}</span>
                            </div>
                            ${item.quantity === 0 ? '<div class="text-xs text-red-500 mb-2">發送完畢</div>' : item.quantity < 5 ? '<div class="text-xs text-orange-500 mb-2">庫存不足</div>' : ''}
                            
                            <div class="space-y-1 text-sm text-gray-600 mb-3">
                                <div>條碼：<span class="font-mono">${item.barcode || '無'}</span></div>
                                <div>建單：${item.createdDate || '-'}</div>
                                <div>更新：${item.lastUpdated}</div>
                            </div>
                            
                            ${item.notes ? `<div class="text-xs text-gray-500 mb-3 line-clamp-2">${item.notes}</div>` : ''}
                            
                            <div class="flex gap-2">
                                <button onclick="openModal('edit', ${index})" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded text-sm font-medium transition-colors duration-200">編輯</button>
                                <button onclick="deleteItem(${index})" class="flex-1 bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded text-sm font-medium transition-colors duration-200">刪除</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // 點擊 Modal 外部關閉
        document.getElementById('itemModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        document.getElementById('barcodeModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeBarcodeScanner();
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'95c866bf62c4f1c8',t:'MTc1MjA3MDE5Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>